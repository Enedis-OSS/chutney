#SPDX-FileCopyrightText: 2017-2024 Enedis
#SPDX-License-Identifier: Apache-2.0

#
# This file is executed via TestContainers framework.
# It aims to define the test environment of Chutney's SSH acceptances tests.
#
# Chutney server is in a specific network and its exposure is made from 'AcceptanceTests' class.
#
# For SSH tests, we define 4 services :
#   * jump-host : A ssh service with shell and which is meant to be accessible via Chutney network on port 22.
#   * intern-host : A ssh service with shell and which is meant to be accessible only by the jump-host on port 22.
#   * intern-jump-host : A ssh service with shell and which is meant to be accessible only by the jump-host on port 22.
#   * intern-host-bis : A ssh service with shell and which is meant to be accessible only by the intern-jump-host on port 22.
#
# Network schema :
## ------------------------- chutney_network -------------------------
##       |                                         |
## chutney instance                            jump host
##                                                 |
## ------------------------- ssh_network -------------------------
##       |                                         |
## intern host                              intern jump host
##                                                 |
## ------------------------- ssh_network_bis -------------------------
##       |
## intern host bis
#
# Access keys are in test resources under blackbox/env/ssh directory.
# see https://github.com/threatpatrols/docker-sshjumphost
#

services:

  jump-host:
    image: threatpatrols/sshjumphost:latest
    restart: unless-stopped
    networks:
      - chutney_network
      - ssh_network
    volumes:
      - "./authorized_keys:/data/userkeys"
    environment:
      SSH_USERNAME: "jumpuser"
      SSH_SHELL: "/bin/bash"
      SSH_AUTHORIZED_KEYS: "/data/userkeys/client-jump-id_ecdsa.pub"

  intern-host:
    image: threatpatrols/sshjumphost:latest
    restart: unless-stopped
    networks:
      - ssh_network
    volumes:
      - "./authorized_keys:/data/userkeys"
    environment:
      SSH_USERNAME: "internuser"
      SSH_SHELL: "/bin/bash"
      SSH_AUTHORIZED_KEYS: "/data/userkeys/client-intern-id_edcsa.pub"

  intern-jump-host:
    image: threatpatrols/sshjumphost:latest
    restart: unless-stopped
    networks:
      - ssh_network
      - ssh_network_bis
    volumes:
      - "./authorized_keys:/data/userkeys"
    environment:
      SSH_USERNAME: "jumpuserbis"
      SSH_SHELL: "/bin/bash"
      SSH_AUTHORIZED_KEYS: "/data/userkeys/client-intern-jump-id_ecdsa.pub"

  intern-host-bis:
    image: threatpatrols/sshjumphost:latest
    restart: unless-stopped
    networks:
      - ssh_network_bis
    volumes:
      - "./authorized_keys:/data/userkeys"
    environment:
      SSH_USERNAME: "internuserbis"
      SSH_SHELL: "/bin/bash"
      SSH_AUTHORIZED_KEYS: "/data/userkeys/client-intern-bis-id_edcsa.pub"

networks:
  chutney_network:
    name: chutney_network
    external: true
  ssh_network:
  ssh_network_bis:
